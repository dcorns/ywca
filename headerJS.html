<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function(){
        (function(){
            //Centralize frequently used, static parameters and dependent functions for location stories
            var mapSpec = {
                idx: 0,
                frame: document.getElementById('myFrame'),
                contentRoot: 'http://firesteelwa.org/',
                defaultStory: 'fpdefault',
                idPrefix: 'fp',
                /*addMarkerClickEvents
                 Adds a click event handler to all markers associated with the given map index (this.idx) that will call this.displayStory with the marker id (mapMarkers[i]._markerObj.id).
                 */
                addMarkerClickEvents: function addMarkerClickEvents(){
                    var mapMarkers = g_gmlAllMaps[this.idx]._markers;
                    var i = 0, len = mapMarkers.length;
                    for(i; i < len; i++){
                        (function(idx) {
                            mapMarkers[idx]._markerObj.addListener('click', function(){this.displayStory(mapMarkers[idx]._markerObj.id);});
                        })(i);
                    }
                },
                /*If this.contentRoot + this.idPrefix returns data, the data is used to replace the HTML in this.frame else this.loadDefaultPage is called.
                 */
                displayStory: function displayStory(id){
                    if(id){
                        ajaxGetJson(this.contentRoot + this.idPrefix + id + '?json=1', function(err, data){
                            if(err) mapSpec.loadDefaultPage();
                            else{
                                this.frame.html(data.json.page.content);
                            }
                        });
                    }
                    else {
                        this.loadDefaultPage();
                    }
                },
                /*If this.contentRoot + this.defaultStory returns data, it is used to replace the HTML in this.frame else a fallback message is used to replace the HTML.
                 */
                loadDefaultPage: function loadDefaultPage(){
                    ajaxGetJson(this.contentRoot + this.defaultStory + '?json=1', function(err, data){
                        if(err) console.log(err);
                        if(data.json.page.content){
                            this.frame.html(data.json.page.content);
                        }
                        else {
                            this.frame.html('<h1>No Details provided for this location</h1>');
                        }
                    });
                },
                //Insure the map is completely loaded before accessing it
                startScripts: function startScripts(){
                    mapMarkers[idx].addEventListener('idle', function(){
                        console.log('map idle');
                    });
//                    google.maps.addListenerOnce(g_gmlAllMaps[this.idx]._mapObj, 'idle', function(){
//                        console.log('map fully loaded');
//                        this.addMarkerClickEvents();
//                        this.loadDefaultPage();
//                        lockMapArea(mapSpec.idx);
//                    });
                }
            };

//            mapSpec.addMarkerClickEvents();
//            mapSpec.loadDefaultPage();
//            lockMapArea(mapSpec.idx);

            /*lockMapArea (original code by James Gifford refactored by Dale Corns
             mapIdx = Int
             Sets the boundaries of the map with the index of mapIdx to LatLng(45.67, -123.78) and LatLng(48.849590, -117.130344)
             */
            function lockMapArea(mapIdx){
                var map = g_gmlAllMaps[mapIdx]._mapObj, googMaps = google.maps;
                var strictBounds = new googMaps.LatLngBounds(
                        new googMaps.LatLng(45.67, -123.78),
                        new googMaps.LatLng(48.849590, -117.130344)
                );

                // Listen for the dragend event
                googMaps.event.addListener(map, 'dragend', function() {
                    if (strictBounds.contains(map.getCenter())) return;
                    // We're out of bounds - Move the map back within the bounds

                    var c = map.getCenter(),
                            x = c.lng(),
                            y = c.lat(),
                            maxX = strictBounds.getNorthEast().lng(),
                            maxY = strictBounds.getNorthEast().lat(),
                            minX = strictBounds.getSouthWest().lng(),
                            minY = strictBounds.getSouthWest().lat();

                    if (x < minX) x = minX;
                    if (x > maxX) x = maxX;
                    if (y < minY) y = minY;
                    if (y > maxY) y = maxY;

                    map.setCenter(new googMaps.LatLng(y, x));
                });
            }
            /*ajaxGetJson
             url = String
             cb = Function
             Makes an ajax get request to url and executes cb passing in two parameters. An error parameter and a data parameter if the get request is successful, it will set the first parameter(error) to null and the second parameter to {json: JSON.parse(data received), rawAjaxRequest: the ajax request object}. else the first parameter is set to {statusCode: server status code, rawAjaxRequest: the ajax request object}
             */
            function ajaxGetJson(url, cb){
                var ajaxReq = new XMLHttpRequest();
                ajaxReq.addEventListener('load', function(){
                    if(ajaxReq.status === 200) cb(null, {json: JSON.parse(ajaxReq.responseText), rawAjaxRequest: ajaxReq});
                    else cb({statusCode: ajaxReq.status, rawAjaxRequest: ajaxReq}, null);
                });
                ajaxReq.addEventListener('error', function(data){
                    console.log(data);
                    var err = new Error('A fatal error occurred during ajaxGetJson, see console for more information');
                    err.name = 'XMLHttpRequestError';
                    cb(err, null);
                });
                ajaxReq.open('GET', url, true);
                ajaxReq.send();
            }
        })();
    });
</script>